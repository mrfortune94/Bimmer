name: Build BimmerLink APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Install build tools
      run: |
        sudo apt-get update
        sudo apt-get install -y zipalign apksigner
    
    - name: Download APKTool
      run: |
        wget https://raw.githubusercontent.com/iBotPeaches/Apktool/master/scripts/linux/apktool
        wget https://github.com/iBotPeaches/Apktool/releases/download/v2.9.3/apktool_2.9.3.jar
        chmod +x apktool
        sudo mv apktool /usr/local/bin/
        sudo mv apktool_2.9.3.jar /usr/local/bin/apktool.jar
    
    - name: Verify APKTool installation
      run: apktool --version
    
    - name: Download and verify ZIP file
      run: |
        set -e
        echo "Downloading ZIP file..."
        wget "https://www.apk.gold/download/BimmerLink.ver.2.36.6-6860.build.6860.apk_Decompiler.com.zip"
        
        echo "ZIP file size:"
        ls -lh "BimmerLink.ver.2.36.6-6860.build.6860.apk_Decompiler.com.zip"
        
        echo "ZIP file contents:"
        unzip -l "BimmerLink.ver.2.36.6-6860.build.6860.apk_Decompiler.com.zip" || true

    - name: Extract ZIP and verify contents
      run: |
        set -e
        mkdir -p extracted_apks
        
        echo "=== Extracting ZIP file ==="
        unzip -o "BimmerLink.ver.2.36.6-6860.build.6860.apk_Decompiler.com.zip" -d extracted_apks
        # Allow warnings - unzip returns non-zero on path warnings but files extract fine
        
        echo "=== Extracted files ==="
        find extracted_apks -type f
        
        # Find base.apk dynamically
        BASE_APK=$(find extracted_apks -name "base.apk" -type f | head -n 1)
        
        if [ -z "$BASE_APK" ]; then
          echo "ERROR: base.apk not found!"
          echo "All extracted files:"
          find extracted_apks -ls
          exit 1
        fi
        
        echo "Found base.apk at: $BASE_APK"
        echo "BASE_APK_PATH=$BASE_APK" >> $GITHUB_ENV
        
        # Verify it's a valid APK
        unzip -t "$BASE_APK" || {
          echo "ERROR: base.apk is corrupted or not a valid APK"
          exit 1
        }
        echo "base.apk verification successful"

    - name: Decompile APK
      run: |
        echo "Decompiling $BASE_APK_PATH..."
        apktool d "$BASE_APK_PATH" -o decompiled -f
    
    - name: List decompiled contents
      run: |
        echo "Decompiled structure:"
        ls -la decompiled/
    
    - name: Modify AndroidManifest.xml
      run: |
        echo "Original AndroidManifest.xml:"
        cat decompiled/AndroidManifest.xml
        
        # Remove debuggable="false" if present and add debuggable="true"
        sed -i 's/android:debuggable="false"//g' decompiled/AndroidManifest.xml
        sed -i 's/<application /<application android:debuggable="true" /' decompiled/AndroidManifest.xml
        
        echo "Modified AndroidManifest.xml:"
        cat decompiled/AndroidManifest.xml
    
    - name: Rebuild APK
      run: |
        echo "Rebuilding APK..."
        apktool b decompiled -o BimmerLink-debug-unsigned.apk
    
    - name: Generate keystore
      run: |
        keytool -genkeypair -v -keystore my-release-key.jks \
          -alias my-key-alias -keyalg RSA -keysize 2048 -validity 10000 \
          -storepass android -keypass android \
          -dname "CN=Android Debug,O=Android,C=US"
    
    - name: Sign APK
      run: |
        apksigner sign --ks my-release-key.jks \
          --ks-key-alias my-key-alias \
          --ks-pass pass:android \
          --key-pass pass:android \
          --out BimmerLink-debug.apk \
          BimmerLink-debug-unsigned.apk
    
    - name: Verify APK signature
      run: |
        apksigner verify BimmerLink-debug.apk
        echo "APK signed successfully!"
    
    - name: Upload APK
      uses: actions/upload-artifact@v3
      with:
        name: BimmerLink-debug
        path: BimmerLink-debug.apk
